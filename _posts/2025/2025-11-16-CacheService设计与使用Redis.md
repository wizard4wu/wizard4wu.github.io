---
title: 'Cache Serviceè®¾è®¡ä¸ä½¿ç”¨'
key: key-2025-11-14-rediscache
date: 2025-11-14 12:15:26
tags: ["redis"]
comment: true
footer: true
show_edit_on_github: false
pageview: true
lightbox: true
aside:
toc: true
show_subscribe: false
---
## 1. èƒŒæ™¯ä¸è®¾è®¡åˆè¡·
åœ¨è®¸å¤šé¡¹ç›®ä¸­ï¼ŒRedis å¸¸è¢«ä»¥åŸç”Ÿæ–¹å¼ä½¿ç”¨ï¼Œå¯¼è‡´ä»¥ä¸‹é—®é¢˜ï¼š
+ å„æ¨¡å— Redis æ“ä½œé›¶æ•£é‡å¤ï¼Œå¼€å‘ä¸ç»´æŠ¤æˆæœ¬é«˜ï¼›
+ ç¼ºä¹ç»Ÿä¸€çš„åºåˆ—åŒ–ä¸å‘½åè§„èŒƒï¼›
+ åˆ†å¸ƒå¼é”ã€ç¼“å­˜ç­–ç•¥ç­‰åŠŸèƒ½å®ç°ä¸ä¸€è‡´;
+ å¤åˆ¶ç›¸åŒçš„ä»£ç åˆ°ä¸åŒé¡¹ç›®ä¸­ï¼›

**cache-service çš„è®¾è®¡åˆè¡·æ˜¯**ï¼š
å¯¹åŸç”Ÿ Redis è¿›è¡Œç»Ÿä¸€å°è£…ï¼Œæä¾›ç®€æ´ã€æ˜“ç”¨ã€å¯æ‰©å±•çš„æ¥å£ï¼Œä½¿ä¸šåŠ¡å¼€å‘è€…ä¸“æ³¨æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œæ— éœ€å…³æ³¨åº•å±‚ Redis ç»†èŠ‚ã€‚åŒæ—¶ï¼Œä¸ºæœªæ¥åŠŸèƒ½æ‰©å±•ä¸å®¢æˆ·ç«¯å‡çº§æä¾›ä¾¿åˆ©ã€‚
æ•´ä½“è®¾è®¡éš¾åº¦ä¸€èˆ¬ï¼Œç»“åˆå‡½æ•°å¼ç¼–ç¨‹æ€æƒ³ï¼Œå®ç°å¼€å‘ç®€åŒ–ï¼ŒåŒæ—¶æä¾›æ–¹æ³•å°è£…å’Œæ³¨è§£æ”¯æŒã€‚

é¡¹ç›®åœ°å€ï¼š[ç‚¹æ­¤è¿›å…¥](https://github.com/wizard4wu/cache-service)
## 2. è®¾è®¡ç†å¿µä¸æ ¸å¿ƒç‰¹æ€§

cache-service æä¾›â€œå¼€ç®±å³ç”¨â€çš„ Redis é›†æˆæ–¹å¼ï¼š
+ å¦‚æœé¡¹ç›®å·²æœ‰è‡ªå®šä¹‰ Redis Beanï¼Œåˆ™ä¼˜å…ˆä½¿ç”¨ï¼›
+ è‹¥æ— ï¼Œåˆ™ç”±ç»„ä»¶è‡ªåŠ¨åˆ›å»º Redis Beanï¼›
+ ç»„ä»¶ä¾èµ–çš„ç‰ˆæœ¬å·ä¼˜å…ˆä½¿ç”¨é¡¹ç›®ç¯å¢ƒæä¾›ç‰ˆæœ¬ï¼Œå®ç°**æ— ç¼æ¥å…¥**ï¼›
### **âœ… æ ¸å¿ƒç‰¹æ€§**
| **åŠŸèƒ½ç‚¹**             | **è¯´æ˜**                                      |
| ---------------------- | --------------------------------------------- |
| **ç¼“å­˜å‡»ç©¿ä¿æŠ¤**       | é»˜è®¤å…³é—­ï¼Œå¯æŒ‰éœ€å¯ç”¨ (**ä»…å¯¹Stringç±»å‹æœ‰æ•ˆ**) |
| **æ³¨è§£å¼ç¼“å­˜éš”ç¦»**     | é€šè¿‡å‘½åç©ºé—´åŒºåˆ†ä¸åŒä¸šåŠ¡æ¨¡å—                  |
| **Lambda å›æºæ”¯æŒ**    | æ”¯æŒ function å‡½æ•°æ‰§è¡Œåå›å¡«ç¼“å­˜              |
| **å¤æ‚å¯¹è±¡åºåˆ—åŒ–**     | æ”¯æŒé›†åˆã€å¯¹è±¡ç±»å‹åºåˆ—åŒ–ä¸ååºåˆ—åŒ–            |
| **åˆ†å¸ƒå¼é”ä¸å¹‚ç­‰ä¿æŠ¤** | æä¾›æ³¨è§£å¼å£°æ˜ä½¿ç”¨                            |

ğŸ’¡ æ³¨æ„ï¼šç¼“å­˜ç©¿é€ä¿æŠ¤å¹¶éæ‰€æœ‰ä¸šåŠ¡éƒ½å¿…é¡»å¼€å¯ã€‚å¯¹äºæ•°æ®ç¨³å®šæˆ–è®¿é—®é‡è¾ƒå°çš„ç³»ç»Ÿï¼Œç¼“å­˜ç©ºå€¼å¯èƒ½é€ æˆå†…å­˜æµªè´¹æˆ–é€»è¾‘æ··ä¹±ï¼Œå› æ­¤é»˜è®¤å…³é—­ã€‚
**è¿‡æœŸæ—¶é—´ç­–ç•¥è¯´æ˜**
+ å•keyçš„API é»˜è®¤è¿‡æœŸæ—¶é—´ï¼š30 åˆ†é’Ÿï¼ˆRedis ä»…ç”¨äºç¼“å­˜ï¼Œä¸ä½œä¸ºæŒä¹…åŒ–æ•°æ®åº“ä½¿ç”¨ï¼‰
+ æ‰¹é‡æ“ä½œä¸è®¾ç½®é»˜è®¤è¿‡æœŸæ—¶é—´ï¼Œå› ä¸ºæ‰¹é‡æ“ä½œæœ¬èº«æ—¨åœ¨å‡å°‘ RPC è°ƒç”¨ï¼Œå¦‚æœå¾ªç¯è°ƒç”¨è®¾ç½®è¿‡æœŸæ—¶é—´ä¼šå¤±å»æ‰¹é‡æ“ä½œçš„æ„ä¹‰ï¼›

**é›†åˆç±»ç¼“å­˜ä¸ºä½•ä¸å¯ç”¨å‡»ç©¿ä¿æŠ¤**
+ é›†åˆç±»å‹é€šå¸¸åŒ…å«å¤šæ¡æ•°æ®ï¼Œåªè¦å­˜åœ¨ä»»æ„ä¸€æ¡å³å¯é˜²æ­¢å‡»ç©¿ï¼›
+ ä¸ String ç±»å‹ä¸åŒï¼ŒString ç¼“å­˜å‡»ç©¿é£é™©æ›´é«˜ï¼Œå› æ­¤é»˜è®¤åªå¯¹ String å¼€å¯ä¿æŠ¤ï¼›
+ ä»£ç ä¸­å·²é¢„ç•™ç›¸å…³å­—æ®µï¼Œä¾¿äºæœªæ¥æŒ‰éœ€æ‰©å±•ï¼›

## 3. ä½¿ç”¨ç¤ºä¾‹

1ï¸âƒ£ åŸºæœ¬ç¼“å­˜ä½¿ç”¨

```java
// å£°æ˜ user æ¨¡å—çš„ç¼“å­˜keyå‰ç¼€
@RedisCache("user")
private MyRedisCache redisCache;

// è·å–ç¼“å­˜ï¼Œè‹¥ä¸å­˜åœ¨åˆ™å›æºæ•°æ®åº“å¹¶è‡ªåŠ¨å›å¡«
TestUser result = redisCache.get(key, TestUser.class, () -> {
    log.info("Cache miss, loading from DB...");
    return userMapper.getUserById("id");
}, 30, TimeUnit.MINUTES);

// order æ¨¡å—å¼€å¯ç¼“å­˜å‡»ç©¿ä¿æŠ¤
@RedisCache(value = "order", preventCachePenetration = true)
private MyRedisCache orderCache;

// è‹¥å›æºæ•°æ®ä¸ºç©ºï¼Œåˆ™ç¼“å­˜ç©ºå€¼ 1 åˆ†é’Ÿ
TestUser result2 = orderCache.get(key, TestUser.class, () -> {
    log.info("Cache miss, loading from DB...");
    return userMapper.getUserById("id");
}, 30, TimeUnit.MINUTES);
```
2ï¸âƒ£ Redis é›†åˆæ“ä½œ

```java

// å£°æ˜æ¨¡å—çš„ç¼“å­˜keyå‰ç¼€
@RedisCache("test")
private MyRedisCache redisCache;
private RedisRawListCache<TestUser> listCache;
@PostConstruct
public void init() {
    listCache = redisCache.listCache(TestUser.class);
}
TestUser user1 = new TestUser(11111L, "bob", Instant.now());
Long result1 = listCache.leftPushIfPresent(key, user1);
```
3ï¸âƒ£ åˆ†å¸ƒå¼é”ä½¿ç”¨
+ keyï¼šå­—ç¬¦ä¸²æˆ–å¯¹è±¡å­—æ®µç»„åˆ
+ lockExpiredTimeï¼šé”è¿‡æœŸæ—¶é—´ï¼ˆmsï¼‰ï¼Œé»˜è®¤ä½¿ç”¨ WatchDog
+ tryLockTimeï¼šå°è¯•è·å–é”æ—¶é—´ï¼Œé»˜è®¤ 2 ç§’
```java
// å­—ç¬¦ä¸²å‚æ•°ä½œä¸º key
@RedisLock(key = "'user:' + #userId")
public void testRedisLock(String userId) throws InterruptedException {
    Thread.sleep(50000L);
    log.info("testRedisLock userId: {}", userId);
}

// å¯¹è±¡å­—æ®µç»„åˆä¸º key
@RedisLock(key = "'order:' + #order.id + ':user:' + #user.id")
public void createOrder(OrderDTO order, UserDTO user) { ... }

```
âš ï¸ æ³¨æ„ï¼š
+ è‹¥å¯¹è±¡å­—æ®µä¸º nullï¼Œç”Ÿæˆçš„ key ä¼šä½¿ç”¨ "null" å­—ç¬¦ä¸²ï¼›
+ è‹¥å¯¹è±¡æœ¬èº«ä¸º nullï¼Œä¼šç›´æ¥æŠ¥é”™ï¼›
+ å¤šæ³¨è§£ä»£ç†å¯¹è±¡æ—¶ï¼Œæ³¨æ„æ‰§è¡Œé¡ºåºï¼›


4ï¸âƒ£ å¹‚ç­‰æ³¨è§£ä½¿ç”¨
â€¢	ç”¨æ³•ä¸åˆ†å¸ƒå¼é”ç±»ä¼¼
â€¢	expiredTimeï¼šå¹‚ç­‰è¿‡æœŸæ—¶é—´ï¼ˆmsï¼‰ï¼Œé»˜è®¤ä¸€å¤©
```java
@RedisIdempotent(key = "'order:' + #order.id", expiredTime = 5000)
public void submitOrder(OrderDTO order) { ... }
```
## 4. åç»­è§„åˆ’ï¼ˆToDoï¼‰
+ âœ… æ”¯æŒæœ¬åœ°äºŒçº§ç¼“å­˜
+ âœ… ç¼“å­˜å‘½ä¸­ç‡ä¸æ€§èƒ½æŒ‡æ ‡ç»Ÿè®¡
+ âœ… æ”¯æŒç¼“å­˜æ•°æ®å‹ç¼©
+ âœ… æ‰©å±•å¤šå®ä¾‹ Redis æ”¯æŒ
