---
title: 'æ–¹æ¡ˆè®¾è®¡ | åˆ†é¡µç¼“å­˜ç»„ä»¶è®¾è®¡'
key: key-2023-07-01-PageCache
tags: ["Redis","æ–¹æ¡ˆè®¾è®¡"]
comment: true
footer: true
show_edit_on_github: false
pageview: true
lightbox: true
aside:
toc: true
show_subscribe: false
---

## 1.åˆè¡·

åœ¨é¡¹ç›®å¼€å‘ä¸­ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šå°†æŸä¸ªå®Œæ•´å¯¹è±¡å­˜å‚¨åœ¨ç¼“å­˜ä¸­ï¼Œä½†å¾ˆå°‘ä¼šå¯¹**åˆ†é¡µæ•°æ®**åšç¼“å­˜å¤„ç†ã€‚
åœ¨è®¾è®¡è¿™ä¸ªç»„ä»¶ä¹‹å‰ï¼ŒåŸºæœ¬æ²¡æœ‰ä¸“é—¨å¤„ç†åˆ†é¡µç¼“å­˜çš„æ–¹æ¡ˆã€‚

ç”±äº Redis æä¾›äº†ä¸°å¯Œçš„æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬é€‰æ‹©äº†**`ZSet`ï¼ˆæœ‰åºé›†åˆï¼‰** æ¥æ”¯æŒåˆ†é¡µåœºæ™¯ã€‚

### âœ… ä¸ºä»€ä¹ˆé€‰æ‹© ZSetï¼Ÿ

åˆ†é¡µæ•°æ®é€šå¸¸è¦æ±‚ **æœ‰åº**ï¼Œéœ€è¦æŒ‰æŸä¸ªæŒ‡æ ‡ï¼ˆå¦‚åˆ›å»ºæ—¶é—´ï¼‰æ’åºã€‚

- `ZSet` ä¿è¯äº†æ•°æ®çš„æœ‰åºæ€§ï¼›
- å¯å°†æ’åºå­—æ®µï¼ˆå¦‚åˆ›å»ºæ—¶é—´æˆ³ï¼‰ä½œä¸º `score`ï¼›
- åˆ©ç”¨ `rangeByScore` ç­‰å‘½ä»¤è·å–åˆ†é¡µæ•°æ®ï¼Œé«˜æ•ˆç®€æ´ã€‚

## 2.åˆ†é¡µç¼“å­˜æ–¹æ³•è®º

### 2.1åˆçº§åº”ç”¨

ä»¥è®¢å•æ•°æ®ä½œä¸ºä¾‹å­ã€‚

**ğŸ’¡ åœºæ™¯ï¼šå•†å®¶éœ€è¦æŸ¥çœ‹æŸäº§å“çš„æ‰€æœ‰è®¢å•ï¼ŒæŒ‰åˆ›å»ºæ—¶é—´å€’åºæ’åˆ—ã€‚**

### ğŸ“Œ æ•°æ®ç»“æ„è®¾è®¡

| é¡¹ç›®       | å†…å®¹è¯´æ˜                         |
| ---------- | -------------------------------- |
| ZSet Key   | äº§å“ IDï¼ˆä¾‹å¦‚ï¼š`product:12345`ï¼‰ |
| ZSet Value | è®¢å• IDï¼ˆorderIdï¼‰               |
| ZSet Score | åˆ›å»ºæ—¶é—´ï¼ˆæ—¶é—´æˆ³ï¼‰               |

ä½¿ç”¨ APIï¼š

```Java
ZSetOperations.add(K productId, V orderId, double createdTime);
```

> è®¢å•è¯¦æƒ…æ•°æ®æœ¬èº«ä»ä»¥ `orderId` ä¸º key ç¼“å­˜åœ¨ Redis ä¸­ï¼Œåˆ†é¡µæŸ¥è¯¢ç»“æœä¸­æ‹¿åˆ°ä¸€æ‰¹ orderId åï¼Œå¯è°ƒç”¨ `multiGet()` ä¸€æ¬¡æ€§è·å–å®Œæ•´è¯¦æƒ…ã€‚

### ğŸ“¥ æ•°æ®è·å–æµç¨‹ï¼š

1. ä½¿ç”¨ `rangeByScore(productId, min, max, offset, limit)` è·å–è®¢å• ID åˆ—è¡¨ï¼›
2. ä½¿ç”¨ `multiGet(orderIds)` è·å–è¯¦æƒ…ï¼›
3. è¿”å›ç»“æœã€‚

![image-20250517112202260]({{"/assets/picture/2023-07/image-20250517112202260.png" | absolute_url}})

![image-20250517120534638]({{"/assets/picture/2023-07/image-20250517120534638.png" | absolute_url}})
>Note:
>
>1. nextPageTokençš„æ„å»º: å¦‚æœpageSizeå¤§å°ä¸º10æ—¶ï¼Œåœ¨å»è·å–idæ•°æ®æ—¶ä¸€å®šè¦è·å–11æ¡ï¼Œå› ä¸ºè¦æ ¹æ®æœ€åä¸€æ¡çš„æ•°æ®æ„å»ºæˆnextPageTokenï¼Œä½†æ˜¯è¿”å›çš„æ—¶å€™åªè¿”å›10æ¡æ•°æ®ï¼ˆéœ€è¦å»é™¤ç¬¬11æ¡ï¼‰å’Œå¯¹åº”çš„nextPageTokenï¼›å¦å¤–å¯ä»¥æ ¹æ®è¿”å›çš„æ•°æ®æœ‰å¦ä¸º11æ¡æ¥å†³å®šnext page flag
>
>2. åœ¨å­˜å‚¨è¿‡ç¨‹ä¸­ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºscoreæ—¶ï¼Œå¦‚æœæ•°æ®åº“å­—æ®µå¯¹è¯¥å­—æ®µåªç²¾ç¡®åˆ°ç§’çš„è¯ä¼šå‡ºç°è·å–ä¸åˆ°ä¸‹ä¸€é¡µæ•°æ®çš„å¼‚å¸¸ï¼Œé€ æˆä¸€ä¸ªåŸåœ°è¸æ­¥çš„æƒ…å†µã€‚ä¾‹å¦‚åœ¨å¹¶å‘å¾ˆé«˜çš„ç³»ç»Ÿä¸€ç§’å†…äº§ç”Ÿä¸‰åæ¡è®¢å•æ•°æ®ï¼Œæ­¤æ—¶æ¯ä¸€æ‰¹è·å–æ•°æ®ä¸º20æ¡ï¼Œè¿™å°±å¯¼è‡´nextPageTokenå§‹ç»ˆæ˜¯ç›¸åŒçš„ï¼Œåœ¨è·å–ä¸‹ä¸€é¡µæ•°æ®æ—¶å§‹ç»ˆæ‹¿ç€è¿™ä¸ªæ—¶é—´æˆ³è·å–æ•°æ®å¯¼è‡´ä¸€ç›´åŸåœ°è¸æ­¥ã€‚ï¼ˆè„šæœ¬æ‰¹é‡æ’å…¥æ•°æ®æ—¶ä¼šå¯¼è‡´created_timeç›¸åŒï¼‰
>
>  è§£å†³æ–¹æ³•: a.æé«˜æ•°æ®åº“æ—¶é—´æˆ³å­—æ®µçš„ç²¾ç¡®åº¦ï¼›b.å¢å¤§æŸ¥è¯¢çš„pageSizeå¤§å°ï¼Œä½†æ˜¯è¯¥æ–¹æ³•åªèƒ½é™ä½æ¦‚ç‡ä¸èƒ½å®Œå…¨é¿å…ï¼›

#### âŒ å¤šå­—æ®µåˆ†é¡µé—®é¢˜

è‹¥éœ€è¦æ”¯æŒæŒ‰å¤šä¸ªå­—æ®µåˆ†é¡µï¼ˆå¦‚å¼€å§‹æ—¶é—´ã€ç»“æŸæ—¶é—´ã€æ›´æ–°æ—¶é—´ï¼‰ï¼Œæ¯ä¸ªå­—æ®µéƒ½éœ€å»ºç«‹ç‹¬ç«‹ ZSetï¼Œä¼šå¸¦æ¥æ•°æ®å†—ä½™ã€‚

### 2.2è¿›é˜¶åº”ç”¨

è¿›é˜¶å’Œåˆçº§ä¸»è¦ä¸åŒç‚¹åœ¨äºåœ¨å­˜å…¥æ•°æ®ï¼Œåˆçº§çš„è¯ä¸»è¦å­˜å‚¨çš„æ˜¯ä¸»é”®orderId, è¿›é˜¶çš„è¯ä¸»è¦å­˜å‚¨çš„æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæ ¹æ®rangeByScoreæ¥æ‰¹é‡è·å–å¯¹è±¡ï¼Œå†æ ¹æ®å¯¹è±¡è®¡ç®—å‡ºæ¥æ‰€å¯¹åº”çš„idï¼Œä»è€Œèƒ½å®ç°æ‰¹é‡è·å–æ•°æ®ã€‚å¦‚ä¸‹å¦‚æ‰€ç¤ºï¼ŒpId-1ä¸­ä¼šæœ‰å¤šæ¡æ•°æ®æ»¡è¶³æŸ¥è¯¢æ¡ä»¶ï¼Œæˆ‘ä»¬åªå¸Œæœ›æ˜¾ç¤ºæœªæ¥å‘ç”Ÿçš„ç¬¬ä¸€æ¡ï¼Œè¿™æ—¶æˆ‘ä»¬éœ€è¦æ ¹æ®pId-1è¿›è¡Œä¸€ä¸ªåˆ†ç»„ç„¶åå–å‡ºç¬¬ä¸€æ¡å³å¯ã€‚æ‰€ä»¥å­˜å‚¨çš„å¯¹è±¡ä¸ä»…åŒ…å«oIdè¿˜è¦åŒ…å«pIdï¼Œè¿™å°±å½¢æˆäº†ä¸€ä¸ªå¯¹è±¡ã€‚
![image-20230711223759108]({{"/assets/picture/2023-07/image-20230711223759108.png" | absolute_url}})

## 3.åˆ†é¡µç¼“å­˜å®ç°

1.å®šäºæ•°æ®é¡¶å±‚æ¥å£ï¼Œæ–¹ä¾¿é€å…¥æ•°æ®åˆ°Zseté›†åˆä¸­ï¼š

```java
public interface PageCacheData<T> {
    //æ­¤å¤„ä½¿ç”¨æ³›å‹ä¸»è¦æ˜¯ä¸ºäº†åœ¨è¿›é˜¶åº”ç”¨ä¸­ä½¿ç”¨å¯¹è±¡ä½œä¸ºkeyï¼Œé€šå¸¸æƒ…å†µä¸‹è€Œè¨€ä½¿ç”¨Stringç±»å‹
    T retrievePayload();
    //ç”¨äºè·å–å¯¹è±¡ä¸­çš„æŸä¸ªå‚æ•°ä½œä¸ºæ’åºkeyï¼Œä¹Ÿå°±æ˜¯Zsetä¸­çš„Score
    double retrieveToken();
}
```

2.å†™å…¥æŸæ¡æ•°æ®

```java
    public <T> boolean addData2Page(String key, PageCacheData<T> pageCacheData) {
        try {
            //å°†payloadä¸­çš„æ•°æ®åºåˆ—åŒ–æˆStringå­˜å…¥ï¼Œé€šå¸¸æƒ…å†µä¸‹å°±æ˜¯ä¸€ä¸ªStringç±»å‹çš„æ•°æ®
            String payloadString = objectMapper.writeValueAsString(pageCacheData.retrievePayload());
            return Boolean.TRUE.equals(redisTemplate.opsForZSet().add(key, payloadString,                                      pageCacheData.retrieveToken()));
        }catch (Exception e){

        }
        return false;
    }
```

3.è·å–æ•°æ®

```java
/**
     * 1.å½“ä½¿ç”¨åˆ†é¡µæŸ¥è¯¢æ—¶ï¼ŒnextPageTokenè¦è®¾ç½®æˆæœ€å°å€¼Double.NEGATIVE_INFINITYï¼Œç›´æ¥ä½¿ç”¨offsetå’ŒpageSizeå³å¯
     * 2.å½“ä½¿ç”¨view moreæŸ¥è¯¢æ—¶ï¼Œoffsetè¦è®¾ç½®æˆ0ï¼Œç›´æ¥ä½¿ç”¨nextPageTokenå’ŒpageSize
     * ä½†å¯¹äºnextPageTokenè€Œè¨€çš„è¯ï¼Œè¦å–ä¸Šä¸€æ¡æ•°æ®çš„æœ€åä¸€æ¡æ•°æ®çš„æ—¶é—´æˆ³
     * @param key
     * @param nextPageToken
     * @param offset
     * @param pageSize
     * @return
     * @param <T>
     */
    public <T> Collection<T> getPayloadByToken(String key, double nextPageToken, int offset, int pageSize){
        Set<String> set = redisTemplate.opsForZSet().rangeByScore(key, nextPageToken, Double.POSITIVE_INFINITY, offset, pageSize);
        //ååºæ˜¾ç¤º
        //Set<String> set = redisTemplate.opsForZSet().reverseRangeByScore(key, Double.NEGATIVE_INFINITY, startToken, offset, pageSize);
        try {

            return set.stream().map(value ->{
                try {
                    return objectMapper.readValue(value, new TypeReference<T>() {});
                } catch (JsonProcessingException e) {
                    throw new RuntimeException(e);
                }
            }).collect(Collectors.toList());
        }catch (Exception e){
        }
       return Collections.emptyList();
    }
```

ä¸Šè¿°è·å–çš„æ•°æ®æ˜¯idæ•°æ®ï¼Œä¸ºäº†è·å–åˆ°è¯¦ç»†æ•°æ®ï¼Œè¿˜éœ€è¦æ ¹æ®idæ¥è·å–å¯¹åº”çš„è¯¦ç»†æ•°æ®

4.è·å–åˆ†é¡µæ•°æ®çš„è¯¦ç»†æ•°æ®

```java
  public <V> Collection<V> getPageData(String key, double startToken, int offset, int pageSize){
      //è°ƒç”¨ç¬¬ä¸‰æ¡ä¸­çš„æ–¹æ³•è·å–idsæ•°æ®
      Collection<String> ids = this.getPayloadByToken(key, startToken, offset, pageSize);
      //æ ¹æ®idsæ•°æ®æ¥è·å–æ¯æ¡è¯¦ç»†æ•°æ®
      List<String> objList = redisTemplate.opsForValue().multiGet(ids).stream().filter(Objects::nonNull).collect(Collectors.toList());
      //ååºåˆ—åŒ–æ•°æ®
      return objList.stream().map(order -> {
            try {
                return objectMapper.readValue(order, new TypeReference<V>() {});
            } catch (JsonProcessingException e) {
                throw new RuntimeException(e);
            }
        }).collect(Collectors.toList());
    }
```

5.ç»“æœå‘ˆç°

a). é€šè¿‡é¡µç æ˜¾ç¤ºæ•°æ®
![image-20230702162904931]({{"/assets/picture/2023-07/image-20230702162904931.png" | absolute_url}})

![image-20230702162958107]({{"/assets/picture/2023-07/image-20230702162958107.png" | absolute_url}})
ä¸Šè¿°åˆ†åˆ«æ˜¾ç¤ºäº†ç¬¬ä¸€é¡µç¬¬äºŒé¡µçš„æ•°æ®ï¼Œé€šè¿‡pageNumåˆ†åˆ«æ˜¯1å’Œ2è·å–ï¼Œæ¯ä¸€é¡µ10æ¡æ•°æ®ã€‚

b). é€šè¿‡nextPageTokenæ˜¾ç¤ºæ•°æ®ï¼Œæ­¤æ—¶pageNumè¦è®¾ç½®æˆ1å¹¶ä¸”ä¸è¦æ”¹å˜ï¼Œå¦åˆ™å½±å“è¿”å›æ•°æ®æ­£ç¡®æ€§
![image-20230702163602884]({{"/assets/picture/2023-07/image-20230702163602884.png" | absolute_url}})

![image-20230702163701577]({{"/assets/picture/2023-07/image-20230702163701577.png" | absolute_url}})

ä¸Šè¿°æ˜¯æˆ‘ç›´æ¥æ‹·è´äº†ç¬¬ä¸€é¡µæœ€åä¸€æ¡æ•°æ®çš„startTimeä½œä¸ºnextPageTokenè¿”å›æ•°æ®çš„ï¼Œä½ ä¼šå‘ç°ç¬¬ä¸€é¡µå’Œç¬¬äºŒé¡µå‡ä¼šåŒ…å«ç›¸åŒçš„orderId_9è¿™æ¡æ•°æ®ï¼Œè¿™é—®é¢˜ä¸å¤§ã€‚åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œè¿”å›çš„æ•°æ®æ˜¯åç«¯ä¼šå¸®ä½ æ„å»ºä¸€ä¸ªnextPageTokenè¿›è¡Œè¿”å›ï¼Œå¦‚æœéœ€è¦åˆ°ä¸‹ä¸€é¡µï¼Œå‰ç«¯ç›´æ¥ä½¿ç”¨è¿™ä¸ªnextPageTokenå³å¯è·å–ä¸‹ä¸€é¡µæ•°æ®ã€‚

<font color=red>Note:</font>

1. nextPageTokençš„æ„å»ºï¼Œå¦‚æœpageSizeå¤§å°ä¸º10æ—¶ï¼Œåœ¨å»è·å–idæ•°æ®æ—¶ä¸€å®šè¦è·å–11æ¡ï¼Œå› ä¸ºæœ€åä¸€æ¡çš„æ•°æ®éœ€è¦æ„å»ºæˆnextPageTokenï¼Œä½†æ˜¯è¿”å›çš„æ—¶å€™åªè¿”å›10æ¡æ•°æ®å’Œå¯¹åº”çš„nextPageTokenï¼›

2. åœ¨å­˜å‚¨è¿‡ç¨‹ä¸­ä½¿ç”¨äº‹ä»¶æˆ³ä½œä¸ºscoreæ—¶ï¼Œå¦‚æœæ•°æ®åº“å­—æ®µå¯¹è¯¥å­—æ®µåªç²¾ç¡®åˆ°ç§’çš„è¯ä¼šå‡ºç°è·å–ä¸åˆ°ä¸‹ä¸€é¡µæ•°æ®çš„å¼‚å¸¸ã€‚ä¾‹å¦‚åœ¨å¹¶å‘å¾ˆé«˜çš„ç³»ç»Ÿä¸€ç§’å†…äº§ç”Ÿä¸‰åæ¡è®¢å•æ•°æ®ï¼Œæ­¤æ—¶æ¯ä¸€æ‰¹è·å–æ•°æ®ä¸º20æ¡ï¼Œè¿™å°±å¯¼è‡´nextPageTokenå§‹ç»ˆæ˜¯ç›¸åŒçš„ï¼Œåœ¨è·å–ä¸‹ä¸€é¡µæ•°æ®æ—¶å§‹ç»ˆè¿™ä¸ªæ—¶é—´æˆ³è·å–æ•°æ®å¯¼è‡´ä¸€ç›´åŸåœ°è¸æ­¥ã€‚ï¼ˆè„šæœ¬æ‰¹é‡æ’å…¥æ•°æ®æ—¶ä¼šå¯¼è‡´created_timeç›¸åŒï¼‰

   è§£å†³æ–¹æ³•: a.æé«˜æ•°æ®åº“æ—¶é—´æˆ³å­—æ®µçš„ç²¾ç¡®åº¦ï¼›b.å¢å¤§æŸ¥è¯¢çš„pageSizeå¤§å°ï¼Œä½†æ˜¯è¯¥æ–¹æ³•åªèƒ½é™ä½æ¦‚ç‡ä¸èƒ½å®Œå…¨é¿å…ï¼›

## 4.æ€»ç»“

æœ¬æ–‡è®²è¿°äº†ä½¿ç”¨redisçš„zsetçš„æ•°æ®ç±»å‹å®ç°åˆ†é¡µç¼“å­˜ï¼Œåœ¨zsetä¸­å­˜å‚¨ä¸»é”®idï¼Œå†æ ¹æ®ä¸»é”®idæ‰¹é‡è·å–æ•°æ®è¿”å›ï¼Œæ”¯æŒåˆ†é¡µæŸ¥è¯¢å’Œpage tokenå½¢å¼çš„æŸ¥è¯¢ã€‚

å¯ä»¥ä¼˜åŒ–çš„ç‚¹ï¼š

1. åœ¨zsetçš„æ•°æ®è¿‡æœŸæ—¶ï¼Œæä¾›ä¸€ä¸ªlambdaè¡¨è¾¾å¼ç»™ä¸šåŠ¡æ–¹ï¼Œä¸»è¦ç”¨äºç»´æŠ¤æ•´ä¸ªé¡µé¢çš„ä¸»é”®idé›†åˆï¼›
2. æä¾›æ­£åºå’Œååºçš„æ–¹å¼æŸ¥æ‰¾ï¼›
3. æ•°æ®é‡å¤§æ—¶é‡‡ç”¨æ•°æ®åˆ†ç‰‡ï¼›å°†productId_9912-0, productId_9912-1ï¼›
4. åœ¨é€šè¿‡idsè·å–è¯¦ç»†æ•°æ®æ—¶ï¼Œæ•°æ®å¯èƒ½ä¸åœ¨redisä¸­ï¼Œéœ€è¦æä¾›ä¸€ä¸ªå‡½æ•°è®©ä¸šåŠ¡æ–¹çµæ´»è·å–è‡ªå·±å¯¹åº”æ•°æ®ï¼›
